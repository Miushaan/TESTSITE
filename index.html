<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fleet Maintenance</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-100 text-slate-900 min-h-screen">

<!-- HEADER -->
<header class="sticky top-0 z-30 bg-white border-b p-4 space-y-3">
  <div class="flex justify-between items-center">
    <h1 class="font-black tracking-tight">Fleet Maintenance</h1>
    <div class="flex gap-2">
      <input id="fileInput" type="file" accept=".xlsx,.xls" hidden>
      <button id="importBtn" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-xs font-bold">Import</button>
      <button id="exportBtn" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-xs font-bold">Export</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="flex gap-2 overflow-x-auto">
    <div class="flex-1 bg-white p-3 rounded-2xl shadow text-center">
      <p class="text-xs font-bold text-slate-400">Fleet Progress</p>
      <p id="dashProgress" class="text-xl font-black text-blue-600">0%</p>
    </div>
    <div class="flex-1 bg-white p-3 rounded-2xl shadow text-center">
      <p class="text-xs font-bold text-slate-400">Completed</p>
      <p id="dashCompleted" class="text-xl font-black text-green-600">0</p>
    </div>
    <div class="flex-1 bg-white p-3 rounded-2xl shadow text-center">
      <p class="text-xs font-bold text-slate-400">Pending</p>
      <p id="dashPending" class="text-xl font-black text-orange-600">0</p>
    </div>
    <div class="flex-1 bg-white p-3 rounded-2xl shadow text-center">
      <p class="text-xs font-bold text-slate-400">On Hold</p>
      <p id="dashHold" class="text-xl font-black text-red-600">0</p>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="flex gap-2 flex-wrap">
    <input id="searchInput" placeholder="Search…" class="flex-1 px-3 py-2 rounded-lg border text-sm">
    <select id="statusFilter" class="px-3 py-2 rounded-lg border text-sm">
      <option value="">All Status</option>
      <option>Pending</option>
      <option>On-Going</option>
      <option>Completed</option>
      <option>On Hold</option>
    </select>
    <select id="wsFilter" class="px-3 py-2 rounded-lg border text-sm">
      <option value="">All Workshops</option>
    </select>
    <select id="monthSelect" class="px-3 py-2 rounded-lg border text-sm"></select>
    <select id="yearSelect" class="px-3 py-2 rounded-lg border text-sm"></select>
    <button id="monthlyPdfBtn" class="px-3 py-2 rounded-lg bg-purple-600 text-white text-xs font-bold">
      Monthly PDF
    </button>
  </div>
</header>

<!-- VESSEL TABS -->
<div id="vesselTabs" class="sticky top-[260px] z-20 bg-slate-100 border-b px-4 py-2 flex gap-2 overflow-x-auto"></div>

<!-- TASK LIST -->
<main id="taskList" class="p-4 space-y-3"></main>

<!-- EDIT MODAL -->
<div id="modal" class="fixed inset-0 bg-black/40 hidden z-50 flex items-end sm:items-center justify-center">
  <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-5 space-y-4">
    <div class="flex justify-between items-center">
      <h2 id="modalTitle" class="font-bold text-lg"></h2>
      <button onclick="closeModal()" class="text-slate-400 text-xl">✕</button>
    </div>

    <div id="modalDetails" class="text-sm text-slate-600"></div>

    <label class="text-xs font-bold">Status</label>
    <select id="statusSelect" class="w-full border rounded-lg px-3 py-2 text-sm">
      <option>Pending</option>
      <option>On-Going</option>
      <option>Completed</option>
      <option>On Hold</option>
    </select>

    <label class="text-xs font-bold">Progress</label>
    <input id="progressRange" type="range" min="0" max="100" class="w-full">
    <div id="progressLabel" class="text-xs text-slate-500"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

let tasks = JSON.parse(localStorage.getItem('fleetTasks')||'[]');
let currentVessel='ALL';
let activeTask=null;

const el=id=>document.getElementById(id);

/* DASHBOARD */
const dashProgress=el('dashProgress'),
dashCompleted=el('dashCompleted'),
dashPending=el('dashPending'),
dashHold=el('dashHold');

/* FIX PROGRESS % */
function parseProgress(val){
  if(val==null) return 0;
  return Number(String(val).replace('%','').trim())||0;
}

/* IMPORT */
el('importBtn').onclick=()=>el('fileInput').click();
el('exportBtn').onclick=exportExcel;

el('fileInput').onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>{
    const wb=XLSX.read(ev.target.result,{type:'binary'});
    const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    tasks=data.map((x,i)=>({
      id:Date.now()+i,
      vessel:x['ASSET/SERVICE NAME']||'Unknown',
      wo:x['WO NUMBER']||'',
      task:x['TASK DETAILS']||'',
      date:x['TASK DATE'],
      workshop:x['Workshop']||'N/A',
      status:x['STATUS']||'Pending',
      progress:parseProgress(x['PROGRESS %']),
      notes:[]
    }));
    save(); buildAll(); render();
  };
  r.readAsBinaryString(e.target.files[0]);
};

/* BUILDERS */
function buildAll(){buildTabs();buildWS();buildMonthYear();}

function buildTabs(){
  const v=[...new Set(tasks.map(t=>t.vessel))];
  vesselTabs.innerHTML='';
  ['ALL',...v].forEach(x=>{
    const b=document.createElement('button');
    b.textContent=x==='ALL'?'All Fleet':x;
    b.className=`px-4 py-2 rounded-full text-xs font-bold ${currentVessel===x?'bg-blue-600 text-white':'bg-white border'}`;
    b.onclick=()=>{currentVessel=x;buildTabs();render();}
    vesselTabs.appendChild(b);
  });
}

function buildWS(){
  wsFilter.innerHTML='<option value="">All Workshops</option>';
  [...new Set(tasks.map(t=>t.workshop))].forEach(w=>{
    wsFilter.innerHTML+=`<option>${w}</option>`;
  });
}

function buildMonthYear(){
  monthSelect.innerHTML='<option value="">All Months</option>';
  yearSelect.innerHTML='<option value="">All Years</option>';
  const m=new Set(),y=new Set();
  tasks.forEach(t=>{
    const d=new Date(t.date);
    if(!isNaN(d)){m.add(d.getMonth());y.add(d.getFullYear());}
  });
  [...m].sort().forEach(x=>monthSelect.innerHTML+=`<option value="${x}">${new Date(0,x).toLocaleString('en',{month:'long'})}</option>`);
  [...y].sort().forEach(x=>yearSelect.innerHTML+=`<option>${x}</option>`);
}

/* RENDER */
function render(){
  taskList.innerHTML='';
  const f=tasks.filter(t=>
    (currentVessel==='ALL'||t.vessel===currentVessel)&&
    (!statusFilter.value||t.status===statusFilter.value)&&
    (!wsFilter.value||t.workshop===wsFilter.value)&&
    (t.task.toLowerCase().includes(searchInput.value.toLowerCase())||
     t.wo.toLowerCase().includes(searchInput.value.toLowerCase()))
  );

  dashCompleted.textContent=f.filter(t=>t.status==='Completed').length;
  dashPending.textContent=f.filter(t=>t.status==='Pending').length;
  dashHold.textContent=f.filter(t=>t.status==='On Hold').length;
  dashProgress.textContent=Math.round(f.reduce((a,c)=>a+c.progress,0)/(f.length||1))+'%';

  f.forEach(t=>{
    taskList.innerHTML+=`
    <div onclick="openTask(${t.id})"
      class="bg-white p-4 rounded-2xl shadow cursor-pointer hover:ring-2 ring-blue-200">
      <p class="text-xs font-bold text-blue-600">${t.vessel}</p>
      <p class="font-semibold">${t.task}</p>
      <p class="text-xs">WO: ${t.wo} | ${t.workshop}</p>
      <p class="text-xs">${t.status} – ${t.progress}%</p>
    </div>`;
  });
}

/* EDIT MODAL */
window.openTask=id=>{
  activeTask=tasks.find(t=>t.id===id);
  if(!activeTask) return;
  modal.classList.remove('hidden');
  modalTitle.textContent=activeTask.task;
  modalDetails.innerHTML=`
    <div>Vessel: <b>${activeTask.vessel}</b></div>
    <div>WO: <b>${activeTask.wo}</b></div>
    <div>Workshop: <b>${activeTask.workshop}</b></div>`;
  statusSelect.value=activeTask.status;
  progressRange.value=activeTask.progress;
  progressLabel.textContent=activeTask.progress+'%';
};

statusSelect.onchange=()=>{
  if(!activeTask) return;
  activeTask.status=statusSelect.value;
  save(); render();
};
progressRange.oninput=()=>{
  if(!activeTask) return;
  activeTask.progress=Number(progressRange.value);
  progressLabel.textContent=activeTask.progress+'%';
  save(); render();
};
window.closeModal=()=>modal.classList.add('hidden');

/* MONTHLY PDF (MANAGEMENT COVER) */
monthlyPdfBtn.onclick=()=>{
  const win=window.open('');
  const total=tasks.length;
  const comp=tasks.filter(t=>t.status==='Completed').length;
  const hold=tasks.filter(t=>t.status==='On Hold').length;
  const avg=Math.round(tasks.reduce((a,c)=>a+c.progress,0)/(total||1));

  win.document.write(`
  <h1>Fleet Maintenance Monthly Report</h1>
  <p><b>Total Tasks:</b> ${total}</p>
  <p><b>Completed:</b> ${comp}</p>
  <p><b>On Hold:</b> ${hold}</p>
  <p><b>Average Progress:</b> ${avg}%</p>
  <hr>`);

  [...new Set(tasks.map(t=>t.vessel))].forEach(v=>{
    win.document.write(`<h2>${v}</h2>`);
    const byWS={};
    tasks.filter(t=>t.vessel===v).forEach(t=>{
      (byWS[t.workshop]=byWS[t.workshop]||[]).push(t);
    });
    Object.keys(byWS).forEach(w=>{
      win.document.write(`<h3>Workshop: ${w}</h3><ul>`);
      byWS[w].forEach(t=>{
        win.document.write(`<li>${t.wo} – ${t.task} (${t.status}, ${t.progress}%)</li>`);
      });
      win.document.write('</ul>');
    });
  });

  win.print();
};

/* EXPORT */
function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(tasks);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Tasks');
  XLSX.writeFile(wb,'Fleet_Tasks.xlsx');
}

function save(){localStorage.setItem('fleetTasks',JSON.stringify(tasks));}

buildAll(); render();

});
</script>

</body>
</html>
